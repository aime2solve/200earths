<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparative Biospheromics</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            background-color: #000000;
            font-family: 'Arial', sans-serif;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        h1 {
            color: #00FFFF;
            text-align: center;
            text-shadow: 0 0 10px #00FFFF;
            padding: 10px;
            font-size: 24px;
            margin: 0;
            flex-shrink: 0;
        }
        .container {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
        }
        .sidebar {
            width: 250px;
            background: rgba(26, 26, 26, 0.9);
            border-right: 2px solid #00FFFF;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            height: 100%;
            overflow-y: auto;
            flex-shrink: 0;
        }
        .graph-container {
            flex-grow: 1;
            background-color: #1A1A1A;
            position: relative;
        }
        #graph {
            width: 100%;
            height: 100%;
        }
        .checkbox-container {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .checkbox-container input[type="checkbox"] {
            margin-right: 10px;
            accent-color: #00FFFF;
        }
        .checkbox-container label {
            color: #00FFFF;
            font-size: 14px;
        }
        #stats {
            color: #00FF00;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            padding: 10px;
            background: rgba(26, 26, 26, 0.9);
            border-top: 2px solid #00FFFF;
        }
    </style>
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
</head>
<body>
    <h1>Comparative Biospheromics</h1>
    <div class="container">
        <div class="sidebar" id="sidebar">
            <div id="ecotron-list"></div>
            <div id="stats"></div>
        </div>
        <div class="graph-container">
            <div id="graph"></div>
        </div>
    </div>

    <script>
        console.log('Script started');
        const csvUrl = 'https://raw.githubusercontent.com/aime2solve/200earths/main/200earths.csv';
        let data = [];
        const domeColors = {
            'Control': '#00FFFF', 'High_CO2': '#FF0000', 'Fertilized': '#00FF00', 'Heat': '#FFA500', 'Outside_Control': '#FFFFFF'
        };

        // Initial placeholder plot
        Plotly.newPlot('graph', [{
            x: [1, 2, 3],
            y: [2, 4, 6],
            mode: 'markers',
            marker: { size: 12, color: '#00FFFF' },
            name: 'Loading...'
        }], {
            title: 'Loading 200earths.csv...',
            plot_bgcolor: '#1A1A1A',
            paper_bgcolor: '#1A1A1A',
            font: { color: '#FFFFFF', family: 'Arial, sans-serif', size: 14 },
            xaxis: { gridcolor: '#333333', title: 'CO2 Level (ppm)' },
            yaxis: { gridcolor: '#333333', title: 'Plant Growth Rate (mm/day)' },
            showlegend: true
        }, { responsive: true });

        // Fetch and parse CSV
        fetch(csvUrl)
            .then(response => {
                console.log('Fetch status:', response.status, 'URL:', csvUrl);
                if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
                return response.text();
            })
            .then(csvText => {
                console.log('CSV length:', csvText.length);
                console.log('CSV preview:', csvText.slice(0, 200));
                Papa.parse(csvText, {
                    header: true,
                    dynamicTyping: true,
                    complete: function(results) {
                        data = results.data.filter(row => row.Ecotron && typeof row.Ecotron === 'string');
                        console.log('Parsed data (first 5 rows):', data.slice(0, 5));
                        console.log('Total rows:', data.length);
                        if (data.length === 0) {
                            console.error('No valid data');
                            Plotly.newPlot('graph', [], layoutConfig('No valid data in CSV'));
                            return;
                        }
                        populateEcotrons();
                        updateGraph();
                    },
                    error: function(error) {
                        console.error('Parse error:', error);
                        Plotly.newPlot('graph', [], layoutConfig('CSV Parse Error: ' + error.message));
                    }
                });
            })
            .catch(error => {
                console.error('Fetch error:', error);
                Plotly.newPlot('graph', [], layoutConfig('Failed to load CSV: ' + error.message));
            });

        function populateEcotrons() {
            console.log('Populating ecotrons');
            const ecotrons = [...new Set(data.map(row => row.Ecotron))].sort();
            console.log('Ecotrons:', ecotrons);
            const ecotronList = document.getElementById('ecotron-list');
            ecotrons.forEach(ecotron => {
                const div = document.createElement('div');
                div.className = 'checkbox-container';
                const input = document.createElement('input');
                input.type = 'checkbox';
                input.id = `ecotron-${ecotron}`;
                input.value = ecotron;
                input.checked = true;
                input.addEventListener('change', updateGraph);
                const label = document.createElement('label');
                label.htmlFor = `ecotron-${ecotron}`;
                label.textContent = ecotron;
                div.appendChild(input);
                div.appendChild(label);
                ecotronList.appendChild(div);
            });
        }

        function layoutConfig(title) {
            return {
                title: { text: title, font: { size: 20, color: '#00FFFF', family: 'Arial, sans-serif' } },
                plot_bgcolor: '#1A1A1A',
                paper_bgcolor: '#1A1A1A',
                font: { color: '#FFFFFF', family: 'Arial, sans-serif', size: 14 },
                xaxis: { gridcolor: '#333333', title: 'CO2 Level (ppm)', automargin: true },
                yaxis: { gridcolor: '#333333', title: 'Plant Growth Rate (mm/day)', automargin: true },
                showlegend: true,
                margin: { l: 50, r: 50, t: 80, b: 50 },
                autosize: true
            };
        }

        function linearRegression(x, y) {
            console.log('Regression input - X:', x, 'Y:', y);
            const n = x.length;
            if (n < 2) {
                console.warn('Not enough points for regression:', n);
                return { slope: NaN, intercept: NaN, r2: NaN };
            }
            const sumX = x.reduce((a, b) => a + b, 0);
            const sumY = y.reduce((a, b) => a + b, 0);
            const sumXY = x.map((xi, i) => xi * y[i]).reduce((a, b) => a + b, 0);
            const sumXX = x.map(xi => xi * xi).reduce((a, b) => a + b, 0);
            const sumYY = y.map(yi => yi * yi).reduce((a, b) => a + b, 0);
            const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;
            const r2 = Math.pow((n * sumXY - sumX * sumY) / Math.sqrt((n * sumXX - sumX * sumX) * (n * sumYY - sumY * sumY)), 2);
            console.log('Regression result:', { slope, intercept, r2 });
            return { slope, intercept, r2 };
        }

        function updateGraph() {
            console.log('Updating graph');
            const selectedEcotrons = Array.from(document.querySelectorAll('#ecotron-list input:checked')).map(input => input.value);
            console.log('Selected ecotrons:', selectedEcotrons);

            let filteredData = data;
            if (selectedEcotrons.length > 0) {
                filteredData = data.filter(row => selectedEcotrons.includes(row.Ecotron));
            }
            console.log('Filtered data (first 5):', filteredData.slice(0, 5));

            const traces = [];
            const ecotrons = [...new Set(filteredData.map(row => row.Ecotron))];
            ecotrons.forEach(ecotron => {
                const ecotronData = filteredData.filter(row => row.Ecotron === ecotron);
                const x = ecotronData.map(row => row.CO2_Level).filter(v => typeof v === 'number' && !isNaN(v));
                const y = ecotronData.map(row => row.Plant_Growth_Rate).filter(v => typeof v === 'number' && !isNaN(v));
                console.log(`Ecotron ${ecotron}: X=${x}, Y=${y}`);
                if (x.length > 0 && y.length > 0) {
                    traces.push({
                        x: x,
                        y: y,
                        mode: 'markers',
                        name: ecotron,
                        marker: { size: 8, color: domeColors[ecotronData[0]?.Dome_Type] || '#FFFFFF' }
                    });
                }
            });

            const allX = filteredData.map(row => row.CO2_Level).filter(v => typeof v === 'number' && !isNaN(v));
            const allY = filteredData.map(row => row.Plant_Growth_Rate).filter(v => typeof v === 'number' && !isNaN(v));
            console.log('Regression data - X:', allX, 'Y:', allY);
            let statsText = '';
            if (allX.length >= 2 && allX.length === allY.length) {
                const { slope, intercept, r2 } = linearRegression(allX, allY);
                if (!isNaN(slope) && !isNaN(intercept)) {
                    const xRange = [Math.min(...allX), Math.max(...allX)];
                    traces.push({
                        x: xRange,
                        y: xRange.map(xi => slope * xi + intercept),
                        mode: 'lines',
                        name: 'Best Fit',
                        line: { color: '#FF00FF', width: 2 }
                    });
                    statsText = `Fit: y = ${slope.toFixed(2)}x + ${intercept.toFixed(2)}\nR² = ${r2.toFixed(3)}\nPoints: ${allX.length}`;
                } else {
                    statsText = 'Regression failed';
                }
            } else {
                statsText = 'Need at least 2 points for fit';
            }
            document.getElementById('stats').innerText = statsText;
            console.log('Stats:', statsText);

            console.log('Traces:', traces);
            if (traces.length === 0) {
                Plotly.newPlot('graph', [], layoutConfig('No data to plot'));
                return;
            }

            Plotly.newPlot('graph', traces, layoutConfig('Plant Growth Rate vs CO2 Level'), { responsive: true })
                .then(() => console.log('Plot rendered'))
                .catch(err => console.error('Plotly error:', err));
        }
    </script>
</body>
</html>