<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparative Biospheromics</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap" rel="stylesheet">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            background-color: #000000;
            font-family: 'Exo 2', sans-serif;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        h1 {
            color: #00FFFF;
            text-align: center;
            text-shadow: 0 0 10px #00CC66, 0 0 20px #00CC66;
            padding: 1vh;
            font-family: 'Orbitron', sans-serif;
            font-size: calc(18px + 2vw);
            margin: 0;
            flex-shrink: 0;
            letter-spacing: 3px;
            animation: pulseGlow 1.5s ease-in-out infinite alternate;
        }
        @keyframes pulseGlow {
            from { text-shadow: 0 0 10px #00CC66, 0 0 20px #00CC66; }
            to { text-shadow: 0 0 20px #00CC66, 0 0 40px #00CC66; }
        }
        .container {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
        }
        .sidebar {
            width: 300px;
            background: rgba(26, 26, 26, 0.8);
            border-right: 2px solid #00FFFF;
            box-shadow: 0 0 10px #00FFFF;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            position: fixed;
            height: 100%;
            transition: transform 0.3s ease;
            z-index: 1000;
        }
        .sidebar.collapsed {
            transform: translateX(-280px);
        }
        .sidebar-toggle {
            position: absolute;
            top: 50%;
            right: -20px;
            width: 20px;
            height: 40px;
            background: rgba(26, 26, 26, 0.8);
            border: 2px solid #00FFFF;
            border-left: none;
            border-radius: 0 10px 10px 0;
            color: #00FFFF;
            font-size: 12px;
            line-height: 36px;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 0 8px #00FFFF;
            z-index: 1100;
        }
        .mobile-toggle {
            display: none;
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(26, 26, 26, 0.8);
            border: 2px solid #00FFFF;
            border-radius: 10px;
            color: #00FFFF;
            padding: 5px 10px;
            cursor: pointer;
            box-shadow: 0 0 8px #00FFFF;
            z-index: 1100;
        }
        .button-container {
            display: flex;
            align-items: center;
            width: 100%;
            position: relative;
        }
        .stats-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            position: relative;
        }
        .stats-header {
            display: flex;
            align-items: center;
            width: 100%;
        }
        .button-label {
            color: #FFFF00;
            font-family: 'VT323', monospace;
            font-size: 14px;
            margin-right: 10px;
            width: 100px;
            text-align: right;
            flex-shrink: 0;
        }
        .dropdown-toggle {
            background: rgba(26, 26, 26, 0.8);
            border: 2px solid #00FFFF;
            border-radius: 10px;
            color: #00FFFF;
            font-family: 'Exo 2', sans-serif;
            font-size: 12px;
            padding: 6px 12px;
            box-shadow: 0 0 8px #00FFFF;
            cursor: pointer;
            width: calc(100% - 120px);
            text-align: left;
        }
        .dropdown-toggle:hover {
            box-shadow: 0 0 12px #00FFFF;
        }
        .dropdown-menu {
            display: none;
            position: absolute;
            top: calc(100% + 5px);
            left: 110px;
            width: calc(100% - 120px);
            max-height: 300px;
            overflow-y: auto;
            background: rgba(26, 26, 26, 0.8);
            border: 2px solid #00FFFF;
            border-radius: 10px;
            box-shadow: 0 0 8px #00FFFF;
            z-index: 1000;
            padding: 10px;
            color: #00FFFF;
            font-family: 'Exo 2', sans-serif;
            font-size: 12px;
        }
        .dropdown-menu.open {
            display: block;
        }
        #ecotron-full-list, #independent-menu, #dependent-menu, #view-menu {
            max-height: 400px;
        }
        .dropdown-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .dropdown-item input[type="radio"],
        .dropdown-item input[type="checkbox"] {
            margin-right: 10px;
            accent-color: #00FFFF;
        }
        .dropdown-item.inactive {
            color: #006666;
            pointer-events: none;
        }
        .stats-panel {
            width: calc(100% - 120px);
            max-height: 0;
            background: rgba(26, 26, 26, 0.8);
            border: 2px solid #00FFFF;
            border-radius: 10px;
            box-shadow: 0 0 8px #00FFFF;
            color: #00FF00;
            font-family: 'VT323', monospace;
            font-size: 12px;
            padding: 0;
            overflow: hidden;
            transition: max-height 0.3s, padding 0.1s;
            position: absolute; /* Anchor to container */
            top: 100%; /* Below header */
            right: 0; /* Right edge aligns with buttons */
            margin-top: 5px;
        }
        .stats-panel.open {
            max-height: 150px;
            padding: 10px;
        }
        .graph-container {
            flex-grow: 1;
            margin-left: 300px;
            position: relative;
            background-color: #1A1A1A;
            overflow: hidden;
            min-height: 200px;
            transition: margin-left 0.3s ease;
        }
        .graph-container.full-width {
            margin-left: 0;
        }
        #graph {
            width: 90%;
            height: 90%;
            margin: 5% auto;
        }
        #graph::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                to bottom,
                rgba(0, 255, 255, 0.06),
                rgba(0, 255, 255, 0.06) 2px,
                transparent 2px,
                transparent 4px
            );
            pointer-events: none;
            z-index: 10;
        }
        @media (max-width: 768px) {
            .sidebar {
                width: 250px;
                transform: translateX(-230px);
            }
            .sidebar.open {
                transform: translateX(0);
            }
            .mobile-toggle {
                display: block;
            }
            .graph-container {
                margin-left: 0;
            }
            .button-label {
                width: 80px;
                font-size: 12px;
            }
            .dropdown-menu {
                width: calc(100% - 90px);
                left: 90px;
            }
            .stats-panel {
                width: calc(100% - 90px);
                right: 0; /* Maintain alignment */
            }
            .dropdown-toggle {
                font-size: 10px;
                padding: 4px 8px;
                width: calc(100% - 90px);
            }
            #graph {
                width: 90%;
                height: 90%;
                margin: 5% auto;
            }
        }
        @media (max-width: 480px) {
            h1 {
                font-size: calc(14px + 2vw);
            }
            .sidebar {
                width: 200px;
                transform: translateX(-180px);
            }
        }
    </style>
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
</head>
<body>
    <h1>Comparative Biospheromics</h1>
    <div class="container">
        <button class="mobile-toggle" id="mobile-toggle">☰</button>
        <div class="sidebar" id="sidebar">
            <button class="sidebar-toggle" id="sidebar-toggle">></button>
            <div class="button-container">
                <span class="button-label">Biome:</span>
                <div class="dropdown-toggle" id="biome-toggle">Select Biomes</div>
                <div class="dropdown-menu" id="biome-menu"></div>
            </div>
            <div class="button-container">
                <span class="button-label">Exp. Condition:</span>
                <div class="dropdown-toggle" id="condition-toggle">Select Conditions</div>
                <div class="dropdown-menu" id="condition-menu">
                    <div class="dropdown-item"><input type="checkbox" id="Control" value="Control"><label for="Control">Control</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="High_CO2" value="High_CO2"><label for="High_CO2">High_CO2</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="Fertilized" value="Fertilized"><label for="Fertilized">Fertilized</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="Heat" value="Heat"><label for="Heat">Heat</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="Outside_Control" value="Outside_Control"><label for="Outside_Control">Outside_Control</label></div>
                </div>
            </div>
            <div class="button-container">
                <span class="button-label">Ecotrons:</span>
                <div class="dropdown-toggle" id="ecotron-toggle">Show All</div>
                <div class="dropdown-menu" id="ecotron-full-list"></div>
            </div>
            <div class="button-container">
                <span class="button-label">Independent:</span>
                <div class="dropdown-toggle" id="independent-toggle">CO2_Level</div>
                <div class="dropdown-menu" id="independent-menu">
                    <div class="dropdown-item"><input type="radio" name="independent" id="CO2_Level" value="CO2_Level" checked><label for="CO2_Level">CO2_Level</label></div>
                    <div class="dropdown-item"><input type="radio" name="independent" id="Temperature_Level" value="Temperature_Level"><label for="Temperature_Level">Temperature_Level</label></div>
                    <div class="dropdown-item"><input type="radio" name="independent" id="Fertilizer_Dose" value="Fertilizer_Dose"><label for="Fertilizer_Dose">Fertilizer_Dose</label></div>
                    <div class="dropdown-item"><input type="radio" name="independent" id="GMO_Presence" value="GMO_Presence"><label for="GMO_Presence">GMO_Presence</label></div>
                    <div class="dropdown-item"><input type="radio" name="independent" id="Vector_Presence" value="Vector_Presence"><label for="Vector_Presence">Vector_Presence</label></div>
                </div>
            </div>
            <div class="button-container">
                <span class="button-label">Dependent:</span>
                <div class="dropdown-toggle" id="dependent-toggle">Plant_Growth_Rate</div>
                <div class="dropdown-menu" id="dependent-menu">
                    <div class="dropdown-item"><input type="radio" name="dependent" id="Plant_Growth_Rate" value="Plant_Growth_Rate" checked><label for="Plant_Growth_Rate">Plant_Growth_Rate</label></div>
                    <div class="dropdown-item"><input type="radio" name="dependent" id="Photosynthesis_Rate" value="Photosynthesis_Rate"><label for="Photosynthesis_Rate">Photosynthesis_Rate</label></div>
                    <div class="dropdown-item"><input type="radio" name="dependent" id="Soil_Carbon_Content" value="Soil_Carbon_Content"><label for="Soil_Carbon_Content">Soil_Carbon_Content</label></div>
                    <div class="dropdown-item"><input type="radio" name="dependent" id="Species_Composition" value="Species_Composition"><label for="Species_Composition">Species_Composition</label></div>
                    <div class="dropdown-item"><input type="radio" name="dependent" id="Water_Use_Efficiency" value="Water_Use_Efficiency"><label for="Water_Use_Efficiency">Water_Use_Efficiency</label></div>
                    <div class="dropdown-item"><input type="radio" name="dependent" id="Phenology" value="Phenology"><label for="Phenology">Phenology</label></div>
                    <div class="dropdown-item"><input type="radio" name="dependent" id="Soil_Moisture_Content" value="Soil_Moisture_Content"><label for="Soil_Moisture_Content">Soil_Moisture_Content</label></div>
                    <div class="dropdown-item"><input type="radio" name="dependent" id="Net_Primary_Productivity" value="Net_Primary_Productivity"><label for="Net_Primary_Productivity">Net_Primary_Productivity</label></div>
                    <div class="dropdown-item"><input type="radio" name="dependent" id="Mortality_Rates" value="Mortality_Rates"><label for="Mortality_Rates">Mortality_Rates</label></div>
                    <div class="dropdown-item"><input type="radio" name="dependent" id="Plant_Biomass" value="Plant_Biomass"><label for="Plant_Biomass">Plant_Biomass</label></div>
                    <div class="dropdown-item"><input type="radio" name="dependent" id="Nutrient_Leaching" value="Nutrient_Leaching"><label for="Nutrient_Leaching">Nutrient_Leaching</label></div>
                    <div class="dropdown-item"><input type="radio" name="dependent" id="Soil_Microbial_Activity" value="Soil_Microbial_Activity"><label for="Soil_Microbial_Activity">Soil_Microbial_Activity</label></div>
                    <div class="dropdown-item"><input type="radio" name="dependent" id="Eutrophication_Levels" value="Eutrophication_Levels"><label for="Eutrophication_Levels">Eutrophication_Levels</label></div>
                    <div class="dropdown-item"><input type="radio" name="dependent" id="Gene_Flow" value="Gene_Flow"><label for="Gene_Flow">Gene_Flow</label></div>
                    <div class="dropdown-item"><input type="radio" name="dependent" id="Crop_Yield" value="Crop_Yield"><label for="Crop_Yield">Crop_Yield</label></div>
                    <div class="dropdown-item"><input type="radio" name="dependent" id="Non_Target_Species_Effects" value="Non_Target_Species_Effects"><label for="Non_Target_Species_Effects">Non_Target_Species_Effects</label></div>
                    <div class="dropdown-item"><input type="radio" name="dependent" id="Pest_Resistance" value="Pest_Resistance"><label for="Pest_Resistance">Pest_Resistance</label></div>
                    <div class="dropdown-item"><input type="radio" name="dependent" id="Target_Population_Size" value="Target_Population_Size"><label for="Target_Population_Size">Target_Population_Size</label></div>
                    <div class="dropdown-item"><input type="radio" name="dependent" id="Off_Target_Mutations" value="Off_Target_Mutations"><label for="Off_Target_Mutations">Off_Target_Mutations</label></div>
                    <div class="dropdown-item"><input type="radio" name="dependent" id="Genetic_Diversity" value="Genetic_Diversity"><label for="Genetic_Diversity">Genetic_Diversity</label></div>
                    <div class="dropdown-item"><input type="radio" name="dependent" id="Ecosystem_Trophic_Dynamics" value="Ecosystem_Trophic_Dynamics"><label for="Ecosystem_Trophic_Dynamics">Ecosystem_Trophic_Dynamics</label></div>
                    <div class="dropdown-item"><input type="radio" name="dependent" id="Vector_Persistence" value="Vector_Persistence"><label for="Vector_Persistence">Vector_Persistence</label></div>
                </div>
            </div>
            <div class="button-container">
                <span class="button-label">View:</span>
                <div class="dropdown-toggle" id="view-toggle">Scatter Plot</div>
                <div class="dropdown-menu" id="view-menu">
                    <div class="dropdown-item"><input type="radio" name="view" id="scatter" value="scatter" checked><label for="scatter">Scatter Plot</label></div>
                    <div class="dropdown-item"><input type="radio" name="view" id="bar" value="bar"><label for="bar">Bar Chart</label></div>
                    <div class="dropdown-item"><input type="radio" name="view" id="gene_flow" value="gene_flow"><label for="gene_flow">Gene Flow Plot</label></div>
                    <div class="dropdown-item"><input type="radio" name="view" id="mutation_heatmap" value="mutation_heatmap"><label for="mutation_heatmap">Mutation Heatmap</label></div>
                    <div class="dropdown-item"><input type="radio" name="view" id="diversity_bar" value="diversity_bar"><label for="diversity_bar">Genetic Diversity Bar</label></div>
                </div>
            </div>
            <div class="stats-container">
                <div class="stats-header">
                    <span class="button-label">STATS:</span>
                    <div class="dropdown-toggle" id="stats-toggle">Show Stats</div>
                </div>
                <div class="stats-panel" id="stats-panel"></div>
            </div>
            <div class="button-container">
                <span class="button-label">CSV:</span>
                <div class="dropdown-toggle" id="csv-toggle" onclick="window.open('https://raw.githubusercontent.com/aime2solve/200earths/main/200earths.csv', '_blank')">View CSV</div>
            </div>
        </div>
        <div class="graph-container" id="graph-container">
            <div id="graph"></div>
        </div>
    </div>

    <script>
        console.log('Script started');

        const colors = {
            'Plant_Growth_Rate': '#00FFFF', 'Photosynthesis_Rate': '#FF00FF', 'Soil_Carbon_Content': '#00FF00',
            'Gene_Flow': '#0080FF', 'Off_Target_Mutations': '#80FF80', 'Genetic_Diversity': '#FF8080'
        };

        const domeColors = {
            'Control': '#00FFFF', 'High_CO2': '#FF0000', 'Fertilized': '#00FF00', 'Heat': '#FFA500', 'Outside_Control': '#FFFFFF'
        };

        const units = {
            'CO2_Level': 'ppm', 'Temperature_Level': '°C', 'Fertilizer_Dose': 'kg/ha', 'GMO_Presence': 'binary', 'Vector_Presence': 'binary',
            'Plant_Growth_Rate': 'mm/day', 'Photosynthesis_Rate': 'µmol/m²s', 'Soil_Carbon_Content': '%', 'Gene_Flow': '%',
            'Off_Target_Mutations': '%', 'Genetic_Diversity': 'index'
        };

        const csvUrl = 'https://aime2solve.github.io/200earths/200earths.csv';
        let data = [];

        Plotly.newPlot('graph', [{
            x: [1, 2, 3],
            y: [2, 4, 6],
            mode: 'markers',
            marker: { size: 12, color: '#00FFFF' },
            name: 'Test Data'
        }], {
            title: 'Loading 200earths.csv...',
            plot_bgcolor: '#1A1A1A',
            paper_bgcolor: '#1A1A1A',
            font: { color: '#FFFFFF', family: 'Exo 2, sans-serif', size: 14 },
            xaxis: { gridcolor: '#333333', automargin: true },
            yaxis: { gridcolor: '#333333', automargin: true },
            showlegend: false,
            margin: { l: 50, r: 50, t: 80, b: 50 }
        }, { responsive: true });

        fetch(csvUrl)
            .then(response => {
                console.log('Fetch status:', response.status, 'URL:', csvUrl);
                if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
                return response.text();
            })
            .then(csvText => {
                console.log('CSV length:', csvText.length);
                console.log('CSV preview:', csvText.slice(0, 200));
                Papa.parse(csvText, {
                    header: true,
                    dynamicTyping: true,
                    complete: function(results) {
                        data = results.data.filter(row => row.Ecotron && typeof row.Ecotron === 'string');
                        console.log('Parsed data (first 5 rows):', data.slice(0, 5));
                        console.log('Total rows after filter:', data.length);
                        if (data.length === 0) {
                            console.error('No valid data - missing or invalid Ecotron column');
                            Plotly.newPlot('graph', [], layoutConfig('No valid data in CSV'));
                            return;
                        }
                        populateSelectors();
                        updateGraph();
                    },
                    error: function(error) {
                        console.error('Parse error:', error);
                        Plotly.newPlot('graph', [], layoutConfig('CSV Parse Error: ' + error.message));
                    }
                });
            })
            .catch(error => {
                console.error('Fetch error:', error);
                Plotly.newPlot('graph', [], layoutConfig(`Failed to load CSV: ${error.message}`));
            });

        function populateSelectors() {
            console.log('Populating selectors');
            const biomes = [...new Set(data.map(row => row.Biome))].filter(b => b);
            const ecotrons = [...new Set(data.map(row => row.Ecotron))].filter(e => e);

            const biomeMenu = document.getElementById('biome-menu');
            biomeMenu.innerHTML = '';
            biomes.forEach(biome => {
                const div = document.createElement('div');
                div.className = 'dropdown-item';
                const input = document.createElement('input');
                input.type = 'checkbox';
                input.id = `biome-${biome}`;
                input.value = biome;
                input.checked = true;
                input.addEventListener('change', syncAndUpdate);
                const label = document.createElement('label');
                label.htmlFor = `biome-${biome}`;
                label.textContent = biome;
                div.appendChild(input);
                div.appendChild(label);
                biomeMenu.appendChild(div);
            });

            const conditionMenu = document.getElementById('condition-menu');
            conditionMenu.querySelectorAll('input[type="checkbox"]').forEach(input => {
                input.checked = true;
                input.addEventListener('change', (e) => {
                    const condition = e.target.value;
                    const ecotronList = document.getElementById('ecotron-full-list');
                    ecotronList.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                        if (checkbox.value.includes(condition)) checkbox.checked = e.target.checked;
                    });
                    syncAndUpdate();
                });
            });

            const ecotronFullList = document.getElementById('ecotron-full-list');
            ecotronFullList.innerHTML = '';
            ecotrons.forEach(ecotron => {
                const div = document.createElement('div');
                div.className = 'dropdown-item';
                const input = document.createElement('input');
                input.type = 'checkbox';
                input.id = `ecotron-${ecotron}`;
                input.value = ecotron;
                input.addEventListener('change', syncAndUpdate);
                const label = document.createElement('label');
                label.htmlFor = `ecotron-${ecotron}`;
                label.textContent = ecotron;
                div.appendChild(input);
                div.appendChild(label);
                ecotronFullList.appendChild(div);
            });

            const independentMenu = document.getElementById('independent-menu');
            independentMenu.querySelectorAll('input[type="radio"]').forEach(input => {
                input.addEventListener('change', (e) => {
                    document.getElementById('independent-toggle').textContent = e.target.value;
                    updateGraph();
                });
            });

            const dependentMenu = document.getElementById('dependent-menu');
            dependentMenu.querySelectorAll('input[type="radio"]').forEach(input => {
                input.addEventListener('change', (e) => {
                    document.getElementById('dependent-toggle').textContent = e.target.value;
                    updateViewOptions();
                    updateGraph();
                });
            });

            const viewMenu = document.getElementById('view-menu');
            viewMenu.querySelectorAll('input[type="radio"]').forEach(input => {
                input.addEventListener('change', (e) => {
                    document.getElementById('view-toggle').textContent = document.querySelector(`label[for="${e.target.id}"]`).textContent;
                    updateGraph();
                });
            });

            console.log('Biomes:', biomes);
            console.log('Ecotrons:', ecotrons);
            syncEcotrons();
            updateViewOptions();
        }

        function toggleDropdown(id) {
            const allMenus = ['biome-menu', 'condition-menu', 'ecotron-full-list', 'independent-menu', 'dependent-menu', 'view-menu'];
            allMenus.forEach(menuId => {
                if (menuId !== id) document.getElementById(menuId).classList.remove('open');
            });
            const menu = document.getElementById(id);
            menu.classList.toggle('open');
            if (id === 'ecotron-full-list') syncEcotrons();
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const graphContainer = document.getElementById('graph-container');
            const toggle = document.getElementById('sidebar-toggle');
            sidebar.classList.toggle('collapsed');
            graphContainer.classList.toggle('full-width');
            toggle.innerHTML = sidebar.classList.contains('collapsed') ? '<' : '>';
            Plotly.Plots.resize(document.getElementById('graph'));
        }

        function toggleMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const graphContainer = document.getElementById('graph-container');
            sidebar.classList.toggle('open');
            sidebar.classList.toggle('collapsed');
            graphContainer.classList.toggle('full-width');
            Plotly.Plots.resize(document.getElementById('graph'));
        }

        function syncEcotrons() {
            const biomes = Array.from(document.getElementById('biome-menu').querySelectorAll('input:checked')).map(input => input.value);
            const conditions = Array.from(document.getElementById('condition-menu').querySelectorAll('input:checked')).map(input => input.value);
            const ecotronList = document.getElementById('ecotron-full-list');
            const allEcotrons = ecotronList.querySelectorAll('input[type="checkbox"]');
            let filteredData = data;
            if (biomes.length > 0) filteredData = filteredData.filter(row => biomes.includes(row.Biome));
            if (conditions.length > 0) filteredData = filteredData.filter(row => conditions.includes(row.Dome_Type));
            const validEcotrons = new Set(filteredData.map(row => row.Ecotron));

            allEcotrons.forEach(checkbox => {
                const isValid = validEcotrons.has(checkbox.value);
                checkbox.disabled = !isValid;
                if (!isValid) checkbox.checked = false;
            });

            const checkedEcotrons = new Set(Array.from(allEcotrons).filter(cb => cb.checked).map(cb => cb.value));
            const conditionChecks = {};
            conditions.forEach(cond => conditionChecks[cond] = true);
            allEcotrons.forEach(checkbox => {
                const ecotron = checkbox.value;
                const condition = ecotron.split('_').slice(-1)[0];
                if (checkedEcotrons.has(ecotron) && conditions.includes(condition)) {
                    conditionChecks[condition] = conditionChecks[condition] && true;
                } else if (conditions.includes(condition)) {
                    conditionChecks[condition] = false;
                }
            });
            conditions.forEach(cond => {
                const input = document.getElementById(cond);
                input.checked = conditionChecks[cond] !== false;
            });
        }

        function syncAndUpdate() {
            syncEcotrons();
            updateGraph();
        }

        function updateViewOptions() {
            console.log('Updating view options');
            const dependent = document.querySelector('#dependent-menu input:checked').value;
            const viewMenu = document.getElementById('view-menu');
            const viewOptions = viewMenu.querySelectorAll('.dropdown-item');

            Array.from(viewOptions).forEach(option => {
                const input = option.querySelector('input');
                const value = input.value;
                if (value === 'scatter' || value === 'bar') {
                    option.className = 'dropdown-item';
                } else if (value === 'gene_flow') {
                    option.className = dependent === 'Gene_Flow' ? 'dropdown-item' : 'dropdown-item inactive';
                } else if (value === 'mutation_heatmap') {
                    option.className = dependent === 'Off_Target_Mutations' ? 'dropdown-item' : 'dropdown-item inactive';
                } else if (value === 'diversity_bar') {
                    option.className = dependent === 'Genetic_Diversity' ? 'dropdown-item' : 'dropdown-item inactive';
                }
            });
        }

        function layoutConfig(title = 'Select Variables to Begin') {
            return {
                plot_bgcolor: '#1A1A1A',
                paper_bgcolor: '#1A1A1A',
                font: { color: '#FFFFFF', family: 'Exo 2, sans-serif', size: 14 },
                title: {
                    text: title,
                    font: { size: 24, color: '#00FFFF', family: 'VT323, monospace' },
                    x: 0.5,
                    xanchor: 'center',
                    y: 0.95,
                    yanchor: 'top'
                },
                xaxis: { gridcolor: '#333333', automargin: true },
                yaxis: { gridcolor: '#333333', automargin: true },
                showlegend: false,
                margin: { l: 50, r: 50, t: 80, b: 50 },
                autosize: true
            };
        }

        function linearRegression(x, y) {
            console.log('Running regression - X:', x, 'Y:', y);
            const n = x.length;
            if (n < 2) {
                console.warn('Not enough points for regression:', n);
                return { slope: NaN, intercept: NaN, r2: NaN };
            }
            const sumX = x.reduce((a, b) => a + b, 0);
            const sumY = y.reduce((a, b) => a + b, 0);
            const sumXY = x.map((xi, i) => xi * y[i]).reduce((a, b) => a + b, 0);
            const sumXX = x.map(xi => xi * xi).reduce((a, b) => a + b, 0);
            const sumYY = y.map(yi => yi * yi).reduce((a, b) => a + b, 0);
            const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;
            const r2 = Math.pow((n * sumXY - sumX * sumY) / Math.sqrt((n * sumXX - sumX * sumX) * (n * sumYY - sumY * sumY)), 2);
            console.log('Regression result:', { slope, intercept, r2 });
            return { slope, intercept, r2 };
        }

        function updateGraph() {
            console.log('Updating graph');
            const biomes = Array.from(document.getElementById('biome-menu').querySelectorAll('input:checked')).map(input => input.value);
            const conditions = Array.from(document.getElementById('condition-menu').querySelectorAll('input:checked')).map(input => input.value);
            const selectedEcotrons = Array.from(document.getElementById('ecotron-full-list').querySelectorAll('input:checked')).map(input => input.value);
            const independent = document.querySelector('#independent-menu input:checked').value;
            const dependent = document.querySelector('#dependent-menu input:checked').value;
            const view = document.querySelector('#view-menu input:checked').value;

            console.log('Selections:', { biomes, conditions, selectedEcotrons, independent, dependent, view });

            let filteredData = data;
            if (biomes.length > 0) filteredData = filteredData.filter(row => biomes.includes(row.Biome));
            if (conditions.length > 0) filteredData = filteredData.filter(row => conditions.includes(row.Dome_Type));
            if (selectedEcotrons.length > 0) filteredData = filteredData.filter(row => selectedEcotrons.includes(row.Ecotron));

            console.log('Filtered data (first 5):', filteredData.slice(0, 5));
            let traces = [];
            let layout = layoutConfig(`${dependent} vs ${independent}`);

            if (view === 'scatter') {
                const ecotrons = [...new Set(filteredData.map(row => row.Ecotron))];
                ecotrons.forEach(ecotron => {
                    const ecotronData = filteredData.filter(row => row.Ecotron === ecotron);
                    const condition = ecotronData[0]?.Dome_Type || 'Unknown';
                    const x = ecotronData.map(row => row[independent] !== undefined ? parseFloat(row[independent]) : NaN).filter(v => !isNaN(v));
                    const y = ecotronData.map(row => row[dependent] !== undefined ? parseFloat(row[dependent]) : NaN).filter(v => !isNaN(v));
                    console.log(`Ecotron ${ecotron}: X=${x}, Y=${y}`);
                    if (x.length > 0 && y.length > 0) {
                        traces.push({
                            x: x,
                            y: y,
                            mode: 'markers',
                            name: ecotron,
                            marker: { size: 12, color: domeColors[condition] || '#FFFFFF', line: { width: 2, color: '#FFFFFF' } }
                        });
                    }
                });

                const allX = filteredData.map(row => row[independent] !== undefined ? parseFloat(row[independent]) : NaN).filter(v => !isNaN(v));
                const allY = filteredData.map(row => row[dependent] !== undefined ? parseFloat(row[dependent]) : NaN).filter(v => !isNaN(v));
                console.log('All data for regression - X:', allX, 'Y:', allY);
                let statsText = '';
                if (allX.length >= 2 && allX.length === allY.length) {
                    const { slope, intercept, r2 } = linearRegression(allX, allY);
                    if (!isNaN(slope) && !isNaN(intercept)) {
                        const xRange = [Math.min(...allX), Math.max(...allX)];
                        traces.push({
                            x: xRange,
                            y: xRange.map(xi => slope * xi + intercept),
                            mode: 'lines',
                            name: 'Best Fit',
                            line: { color: '#FF00FF', width: 2 }
                        });
                        statsText = `Fit: y = ${slope.toFixed(2)}x + ${intercept.toFixed(2)}<br>R² = ${r2.toFixed(3)}<br>Points: ${allX.length}`;
                    } else {
                        statsText = 'Regression failed - insufficient valid data';
                    }
                } else {
                    statsText = 'Not enough data points for regression (need at least 2)';
                }
                console.log('Stats text:', statsText);
                document.getElementById('stats-panel').innerHTML = statsText;

                layout.xaxis.title = `${independent} (${units[independent] || ''})`;
                layout.yaxis.title = `${dependent} (${units[dependent] || ''})`;
            } else if (view === 'bar') {
                const ecotrons = [...new Set(filteredData.map(row => row.Ecotron))];
                const x = ecotrons;
                const y = ecotrons.map(ecotron => {
                    const ecotronData = filteredData.filter(row => row.Ecotron === ecotron);
                    const values = ecotronData.map(row => row[dependent] !== undefined ? parseFloat(row[dependent]) : NaN).filter(v => !isNaN(v));
                    return values.length ? values.reduce((sum, val) => sum + val, 0) / values.length : 0;
                });
                const conditions = ecotrons.map(ecotron => filteredData.find(row => row.Ecotron === ecotron)?.Dome_Type || 'Unknown');
                traces.push({
                    x: x,
                    y: y,
                    type: 'bar',
                    marker: {
                        color: conditions.map(dt => domeColors[dt] || '#FFFFFF'),
                        line: { width: 2, color: '#FFFFFF' }
                    }
                });
                layout.xaxis.title = 'Ecotron';
                layout.yaxis.title = `${dependent} (${units[dependent] || ''})`;
                document.getElementById('stats-panel').innerHTML = '';
            } else if (view === 'gene_flow' && dependent === 'Gene_Flow') {
                const url = filteredData.find(row => row.Data_URL)?.Data_URL || '';
                if (url) {
                    Plotly.newPlot('graph', [], layoutConfig(`Gene Flow data at: ${url}`));
                    document.getElementById('stats-panel').innerHTML = '';
                    return;
                }
                const ecotrons = [...new Set(filteredData.map(row => row.Ecotron))];
                ecotrons.forEach(ecotron => {
                    const ecotronData = filteredData.filter(row => row.Ecotron === ecotron);
                    const condition = ecotronData[0]?.Dome_Type || 'Unknown';
                    const x = ecotronData.map(row => row[independent] !== undefined ? parseFloat(row[independent]) : NaN).filter(v => !isNaN(v));
                    const y = ecotronData.map(row => row[dependent] !== undefined ? parseFloat(row[dependent]) : NaN).filter(v => !isNaN(v));
                    if (x.length > 0 && y.length > 0) {
                        traces.push({
                            x: x,
                            y: y,
                            mode: 'lines+markers',
                            name: ecotron,
                            line: { color: domeColors[condition] || '#FFFFFF', width: 2 },
                            marker: { size: 8, color: domeColors[condition] || '#FFFFFF' }
                        });
                    }
                });
                layout.xaxis.title = `${independent} (${units[independent] || ''})`;
                layout.yaxis.title = 'Gene Flow (%)';
                document.getElementById('stats-panel').innerHTML = '';
            } else if (view === 'mutation_heatmap' && dependent === 'Off_Target_Mutations') {
                const url = filteredData.find(row => row.Data_URL)?.Data_URL || '';
                if (url) {
                    Plotly.newPlot('graph', [], layoutConfig(`Mutation data at: ${url}`));
                    document.getElementById('stats-panel').innerHTML = '';
                    return;
                }
                const ecotrons = [...new Set(filteredData.map(row => row.Ecotron))];
                const z = ecotrons.map(ecotron => {
                    const ecotronData = filteredData.filter(row => row.Ecotron === ecotron);
                    return ecotronData.map(row => row[dependent] !== undefined ? parseFloat(row[dependent]) : 0);
                });
                traces.push({
                    z: z,
                    x: filteredData.map(row => row[independent]).slice(0, z[0].length),
                    y: ecotrons,
                    type: 'heatmap',
                    colorscale: 'Viridis'
                });
                layout.xaxis.title = `${independent} (${units[independent] || ''})`;
                layout.yaxis.title = 'Ecotron';
                document.getElementById('stats-panel').innerHTML = '';
            } else if (view === 'diversity_bar' && dependent === 'Genetic_Diversity') {
                const url = filteredData.find(row => row.Data_URL)?.Data_URL || '';
                if (url) {
                    Plotly.newPlot('graph', [], layoutConfig(`Diversity data at: ${url}`));
                    document.getElementById('stats-panel').innerHTML = '';
                    return;
                }
                const ecotrons = [...new Set(filteredData.map(row => row.Ecotron))];
                const x = ecotrons;
                const y = ecotrons.map(ecotron => {
                    const ecotronData = filteredData.filter(row => row.Ecotron === ecotron);
                    const values = ecotronData.map(row => row[dependent] !== undefined ? parseFloat(row[dependent]) : NaN).filter(v => !isNaN(v));
                    return values.length ? values.reduce((sum, val) => sum + val, 0) / values.length : 0;
                });
                const conditions = ecotrons.map(ecotron => filteredData.find(row => row.Ecotron === ecotron)?.Dome_Type || 'Unknown');
                traces.push({
                    x: x,
                    y: y,
                    type: 'bar',
                    marker: {
                        color: conditions.map(dt => domeColors[dt] || '#FFFFFF'),
                        line: { width: 2, color: '#FFFFFF' }
                    }
                });
                layout.xaxis.title = 'Ecotron';
                layout.yaxis.title = 'Genetic Diversity (index)';
                document.getElementById('stats-panel').innerHTML = '';
            } else {
                Plotly.newPlot('graph', [], layoutConfig('View not applicable for this variable'));
                document.getElementById('stats-panel').innerHTML = '';
                return;
            }

            console.log('Traces to plot:', traces);
            if (traces.length === 0) {
                console.warn('No traces generated');
                Plotly.newPlot('graph', [], layoutConfig('No data to plot after filtering'));
                return;
            }
            Plotly.newPlot('graph', traces, layout, { responsive: true })
                .then(() => console.log('Plot rendered successfully'))
                .catch(err => console.error('Plotly error:', err));
        }

        document.getElementById('biome-toggle').addEventListener('click', () => toggleDropdown('biome-menu'));
        document.getElementById('condition-toggle').addEventListener('click', () => toggleDropdown('condition-menu'));
        document.getElementById('ecotron-toggle').addEventListener('click', () => toggleDropdown('ecotron-full-list'));
        document.getElementById('independent-toggle').addEventListener('click', () => toggleDropdown('independent-menu'));
        document.getElementById('dependent-toggle').addEventListener('click', () => toggleDropdown('dependent-menu'));
        document.getElementById('view-toggle').addEventListener('click', () => toggleDropdown('view-menu'));
        document.getElementById('stats-toggle').addEventListener('click', () => {
            const statsPanel = document.getElementById('stats-panel');
            statsPanel.classList.toggle('open');
            document.getElementById('stats-toggle').textContent = statsPanel.classList.contains('open') ? 'Hide Stats' : 'Show Stats';
        });

        document.getElementById('sidebar-toggle').addEventListener('click', toggleSidebar);
        document.getElementById('mobile-toggle').addEventListener('click', toggleMobileSidebar);

        window.addEventListener('resize', () => {
            Plotly.Plots.resize(document.getElementById('graph'));
        });
    </script>
</body>
</html>